<!DOCTYPE html>
<html>
<head>
    <title>Garage Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="styles/jquery-ui.css">
    
    <script type="text/javascript" src = "scripts/libs/jquery/jquery-min.js"></script>
    <script type="text/javascript" src = "scripts/libs/jquery/jquery-ui-min.js"></script>
    <script type="text/javascript" src = "scripts/libs/twaver/t.js"></script>
    <script type="text/javascript" src = "scripts/libs/twaver/dijkstras.js"></script>
    <script type="text/javascript" src = "scripts/libs/twaver/mono.js"></script>
    <script type="text/javascript" src = "resources/fonts/helvetiker_bold.typeface.js"></script>
    
    <script type="text/javascript">
    
    //attributes
    var isDetail = false,navigationEnabled = false;
    
    var envmap = ['images/room.jpg','images/room.jpg','images/room.jpg','images/room.jpg','images/room.jpg','images/room.jpg'],
    	bidFinder = null, typeFinder = null, nameFinder=null;
    
    var mybox=null;
    
    var lanePoints=new Array( 
    	{name: 'p1', position: new Array(-1600,-2000), distance:{p2:3200,p3:1050} },
    	{name: 'p2', position: new Array(1600,-2000), distance:{p1:3200,p4:1050}},
    	{name: 'p3', position: new Array(-1600,-950), distance:{p1:1050, p4: 3200, p5:750}},
    	{name: 'p4', position: new Array(1600,-950), distance:{p2:1050, p3:3200, p7:750} },
    	{name: 'p5', position: new Array(-1600,-200), distance:{p3:750, p6:2500, p8:3200}},
    	{name: 'p6', position: new Array(900,-200), distance:{p5:2500, p7:700,p9: 3200}},
    	{name: 'p7', position: new Array(1600,-200), distance:{p4:750, p6:700, p10:3200}},
    	{name: 'p8', position: new Array(-1600,3000), distance:{p5:3200, p9:2500}},
    	{name: 'p9', position: new Array(900,3000), distance:{p6:3200, p8:2500, p10:700}},
    	{name: 'p10', position: new Array(1600,3000),distance:{p7:3200, p9:700}}
    );
    
    var getNearestPoint=function(x,y){
        var minDistance=Math.pow((this.lanePoints[0].position[0]-x),2)+Math.pow((this.lanePoints[0].position[1]-y),2);
        var minPoint=this.lanePoints[0];
        
        for(var i=1; i<this.lanePoints.length; i++){
            var distance=Math.pow((this.lanePoints[i].position[0]-x),2)+Math.pow((this.lanePoints[i].position[1]-y),2);
            if(distance<minDistance){
                minPoint=this.lanePoints[i];
                minDistance=distance;
            }
        }
        return minPoint;
    };
    
    var leaveParking=function(){
    	var self=this;
    	//remove according to the selected car
    	this.mybox._nodeList._as.forEach(function(e){
    		 if(e._selected){
    		 	 var name=e.getClient('name');
    		 	 if(name && name.endsWith('_Car')){
    		 		 e.getChildren().forEach(function(child) {
    	    			 self.mybox.remove(child);
    	    		 });
    			     self.mybox.remove(e);
    			  }
    		}
    	 });
    	
    	 //remove according to the selected spot where car landed
    	 var floorName=this.$('#create_park_floor').val();
    	 var spotName=this.$('#create_park_spot').val();
		 var carName = floorName+"_"+spotName+"_Car";
    	 var car=this.nameFinder.findFirst(carName);
    	 if(car){
    		 car.getChildren().forEach(function(child) {
    			 self.mybox.remove(child);
    		 });
    		 self.mybox.remove(car);
    	 }
    };
    
    var startParking=function(){
    	 var floorName=this.$('#create_park_floor').val();
    	 var spotName=this.$('#create_park_spot').val();
			 var floor=this.nameFinder.findFirst(floorName);
    	 var spot=this.nameFinder.findFirst(floorName+"_"+spotName);
    	 
    	 if(spot){
    	 	  var parent=spot.getParent();
    	 	  this.createCar(this.mybox, spot.getPositionX(), 70, spot.getPositionZ(), Math.PI/180*5, parent, floorName+"_"+spotName+"_Car");
    	 }
    	
    };
    
    var createNewSpot=function(){
    	 var direction=this.$('#spotdirection').val();
    	 var prefix=this.$('#spotprefix').val();
    	 var numberOfSpot=this.$('#spotnumber').val();
    	 var floorName='B1';
    	 
    	 var areaspot=this.mybox.getSelectionModel().getFirstData();
    	 if(!areaspot){
    	 	   alert("请选择1个空的区域");
    	     return;
    	 }else if('Area'!=areaspot.getClient('name')){
    	 		alert("请选择1个空的区域");
    	     return;
    	 }
    	 console.log(areaspot.getClient('name'));
    	 //var width=areaspot.getWidth();
    	 for(var i=0; i<numberOfSpot; i++){
    	 	    this.createSingleSpot(this.mybox, areaspot.getParent(), areaspot, floorName, prefix+(i+1), 250*i-700, 250, 500);
    	 }
    };
    
    var searchShop=function(){
    	var shopname=this.$('#shopname').val();
    	var startElement=this.mybox.getSelectionModel().getFirstData();
    	
    	var newPos=this.getAbsolutedPosition(startElement);
    	console.log(newPos);
    	
    	// get current floor
    	var floor=null;
    	
    	var sourceNearestPos=this.getNearestPoint(newPos[0], newPos[2]);
    	
    	// hide the existing path
    	
    	// 
    	var g = new Graph();
    	//var vertexs=new Array();
    	for(var i=0; i<this.lanePoints.length; i++){
    		g.addVertex(this.lanePoints[i].name, this.lanePoints[i].distance);
    	}
    	var finalPath=g.shortestPath(sourceNearestPos.name, this.lanePoints[0].name);
    	
    	
    	// person position
    	//var destX=1000, destY=2650;
    	
    	var path=new mono.Path();
  		path.moveTo(sourceNearestPos.position[0], 0, sourceNearestPos.position[1]);
  		for(var i=0; i<finalPath.length; i++){
  		    var posixy=this.getVertexPosition(finalPath[i]);
  		    path.lineTo(posixy[0], 0, posixy[1]);
  		}
  		path = mono.PathNode.prototype.adjustPath(path, 100);
  		var cable=new mono.PathNode(path, 100, 10);
  		cable.s({
  			'm.type': 'phong',
  			'm.specularStrength': 30,
  			'm.color': '#B43104',
  			'm.ambient': '#B43104',
  			'm.texture.repeat': new mono.Vec2(150, 1),
  			'm.texture.image': 'images/wall.jpg',
  			'm.visible': true
  		});
  		cable.setStartCap('plain');
  		cable.setEndCap('plain');
  		cable.setPositionY(20);
  		cable.setClient('name', 'cable');
  		this.mybox.add(cable);
    };
    
    var getVertexPosition=function(vertexName){
    	for(var i=0; i<this.lanePoints.length; i++){
    		if(this.lanePoints[i].name==vertexName){
    			return this.lanePoints[i].position;
    		}
    	}
    };
    
    var getShortestPath=function(source, destination){
    	var points=new Array();
    	return points;
    };
    
    var getAbsolutedPosition=function(element){
    	var currentElement=element;
    	var abs_pos=new Array(0,0,0);
    	while(currentElement){
    		var rotaY=currentElement.getRotationY();
    		if(rotaY==Math.PI || rotaY==-Math.PI)
    		    abs_pos[0]-=currentElement.getPositionX();
    		else
    			  abs_pos[0]+=currentElement.getPositionX();
    		abs_pos[1]+=currentElement.getPositionY();
    		abs_pos[2]+=currentElement.getPositionZ();
    		currentElement=currentElement.getParent();
    	}
    	
    	return abs_pos;
    };
    
    var setup = function(htmlElementId){				
  	   var self=this;
  	    
  	   var camera = new mono.PerspectiveCamera(30, 1.5, 30, 30000);
		   camera.setPosition(-8000,1000,2000);
		
		  var myCanvas=document.getElementById('myCanvas');
  	  var network = new mono.Network3D(this.box, camera, myCanvas);
  	  network.setShowAxis(true);
  	  this.mybox=network.getDataBox();
  	  
  		network.setClearColor('#39609B');
  
  		var interaction = new mono.DefaultInteraction(network);		
  		//interaction.yLowerLimitAngle=Math.PI/180*2;
  		//interaction.yUpLimitAngle=Math.PI/2;
  		interaction.maxDistance=15000;
  		interaction.minDistance=50;
  		interaction.zoomSpeed=1;
  		interaction.panSpeed=0.2;
			var interaction2 = new mono.SelectionInteraction(network);
			var interactions = [interaction, interaction2];
			network.setInteractions(interactions);

  		this.bidFinder = new mono.QuickFinder(network.getDataBox(), 'bid', 'client');
  		this.typeFinder = new mono.QuickFinder(network.getDataBox(), 'type', 'client');
  		this.nameFinder = new mono.QuickFinder(network.getDataBox(), 'name', 'client');
  		network.isSelectable = function(element){ return true; };		
  		mono.Utils.autoAdjustNetworkBounds(network,document.documentElement,'clientWidth','clientHeight');
  		
  		network.getRootView().addEventListener('dblclick', function(e){
  			self.handleDoubleClick(e, network);
  		});	
  		network.getRootView().addEventListener('click', function(e){
  			self.handleClick(e, network);
  		});	

  		this.setupLights(network.getDataBox());

  		this.loadData(network.getDataBox());
  		
  		setEvents(network.getDataBox());
  	};

  	var loadData = function(box){
  		var F1 = this.createFloor(box, 1000, 330, 2000);
  		F1.setPosition(2995, 190, -1655);
  		F1.setClient('type', 'floor');
  		F1.setClient('name', 'F1');
  		
  		decorateFloor(box, F1, function(box, floor) {
		 		var door = this.createDoor(box, null, -750, 0, -550, 'split', 'metal');
		 		door.setRotationY(-Math.PI/2);
		 		door.setParent(floor);
	  		});
  		
  		var F2 = this.createFloor(box, 500, 330, 2000);
  		F2.s({'m.transparent':true,'m.opacity':0.5}).setPosition(3255, 590, -1655);
  		F2.setClient('type', 'floor');
  		F2.setClient('name', 'F2');
  		
  		decorateFloor(box, F2, function(box, floor) {
		 		var door = this.createDoor(box, null, -750, 0, -300, 'split', 'metal');
		 		door.setRotationY(-Math.PI/2);
		 		door.setParent(floor);
	  		});
  		 
  		var B1 = this.createFloor(box, 5000, 0, 5400);
  		B1.setClient('type', 'floor');
  		B1.setClient('name', 'B1');
  		
  		decorateFloor(box, B1, function(box, floor) {
	  		var floorPositionY = 0;//floor.getPositionY();
	  			
		 		//this.createWalls(box);
		 		var shop = this.createShop(box, floor);
		 		shop.setParent(floor);
		 		
		 		var stair = this.createStair(box, floor);
		 		stair.setParent(floor);
		 		
		 	  var lift = this.createLift(box, floor);
		 		lift.setParent(floor);
		 	    
		 		var plant1 = this.createPlant(box, 2200, -2300 );
		 		var plant2 = this.createPlant(box, 2300, -2300);
		 		var plant3 = this.createPlant(box, 2400, -2300);
		 		plant1.setParent(floor);
		 		plant2.setParent(floor);
		 		plant3.setParent(floor);
		 		var plants = new mono.ComboNode([plant1, plant2, plant3], ['+']);
		 		plants.setParent(floor);
		 		
		 		var worker = this.createWorker(box,1000, 2650, Math.PI/2, floor);	
		 		
		 		var spot1 = this.createSpot(box, 0, floorPositionY, -600, false, 'A0', 10, floor);
		 		var spot2 = this.createSpot(box, 0, floorPositionY, -1300, true, 'B0', 10, floor);
		 		var spot3 = this.createSpot(box, 0, floorPositionY, -2300, false, 'C0', 44,floor);
		 		spot1.setParent(floor);
		 		spot2.setParent(floor);
		 		spot3.setParent(floor);
		 		var spots = new mono.ComboNode([spot1, spot2, spot3], ['+']);
		 		spots.setParent(floor);
	 		
	 		  var carspot4 = new mono.Cube();
  		  var area4=this.createSpotArea(box, carspot4, 1600, 800, -200, floorPositionY, 1700, true, floor);
  		  
		 		var poleNodes = this.createPole(box, [-320, -900, -1600, -2600]);
		 		poleNodes.setParent(floor);
		 		
		 		this.createCar(box, -880, 70, -2290, Math.PI/180*5, floor, 'B1_C046_Car');
		 		
		 		this.createTrail(box, floor);

		 		this.createLine(box, floor);	
		 		
		 		var temperatureProbePositions = [[-800, -1800], [800, -1800], [-800, 0], [800, 0], [-800, 1800], [800, 1800]];
		 		for(var i in temperatureProbePositions) {
		 			var position = temperatureProbePositions[i];
		 			var tp = this.createTemperatureProbe(box, position[0], position[1], 'B1_Temperature_'+(i+1));
			 		tp.setParent(floor);
		 		}
		 		
		 		var exit1 = this.createDoor(box, null, 1800, 0, 2600, 'split', 'metal', true, 'Exit');
		 		exit1.setClient('name', 'B1_Exit_1');
		 		exit1.setParent(floor);
		 		
		 		var exit2 = this.createDoor(box, null, -1700, 0, 2200, 'split', 'metal', true, 'Exit');
		 		exit2.setRotationY(-Math.PI/2);
		 		exit2.setClient('name', 'B1_Exit_2');
		 		exit2.setParent(floor);
  		});
  		
  		var B2 = this.createFloor(box, 5000, -400, 5400);
  		B2.setClient('type', 'floor');
  		B2.setClient('name', 'B2');
  		
  		decorateFloor(box, B2, function(box, floor) {
	  		var floorPositionY = 0;//floor.getPositionY();
	  			
		 		var spot1 = this.createSpot(box, 0, floorPositionY, -600, false, 'A0', 01, floor);
		 		var spot2 = this.createSpot(box, 0, floorPositionY, -1300, true, 'B0', 01, floor);
		 		var spot3 = this.createSpot(box, 0, floorPositionY, -2300, false, 'C0', 01, floor);
		 		var spot4 = this.createSpot(box, 0, floorPositionY, 2300, true, 'D0', 01, floor);
		 		var spot5 = this.createSpot(box, 0, floorPositionY, 1300, false, 'E0', 01, floor);
		 		var spot6 = this.createSpot(box, 0, floorPositionY, 600, true, 'F0', 01, floor);
		 		spot1.setParent(floor);
		 		spot2.setParent(floor);
		 		spot3.setParent(floor);
		 		spot4.setParent(floor);
		 		spot5.setParent(floor);
		 		spot6.setParent(floor);
		 		var spots = new mono.ComboNode([spot1, spot2, spot3, spot4, spot5, spot6], ['+']);
		 		spots.setParent(floor);
		 		
		 		var poleNodes = this.createPole(box, [-320, -900, -1600, -2600, 320, 900, 1600, 2600]);
		 		poleNodes.setParent(floor);
		 		
		 		var temperatureProbePositions = [[-800, -1800], [800, -1800], [-800, 0], [800, 0], [-800, 1800], [800, 1800]];
		 		for(var i in temperatureProbePositions) {
		 			var position = temperatureProbePositions[i];
		 			var tp = this.createTemperatureProbe(box, position[0], position[1], 'B2_Temperature_'+(i+1));
			 		tp.setParent(floor);
		 		}
		 		
		 		var exit1 = this.createDoor(box, null, 1800, 0, 2600, 'split', 'metal', true, 'Exit');
		 		exit1.setClient('name', 'B2_Exit_1');
		 		exit1.setParent(floor);
		 		
		 		var exit2 = this.createDoor(box, null, -1700, 0, 2200, 'split', 'metal', true, 'Exit');
		 		exit2.setRotationY(-Math.PI/2);
		 		exit2.setClient('name', 'B1_Exit_2');
		 		exit2.setParent(floor);
	  		});
  		
  		var B3 = this.createFloor(box, 5000, -800, 5400);
  		B3.setClient('type', 'floor');
  		B3.setClient('name', 'B3');
  		
  		decorateFloor(box, B3, function(box, floor) {
	  		var floorPositionY = 0;//floor.getPositionY();
	  			
	  		var spot1 = this.createSpot(box, 0, floorPositionY, -600, false, 'A0', 01, floor);
		 		var spot2 = this.createSpot(box, 0, floorPositionY, -1300, true, 'B0', 01, floor);
		 		var spot3 = this.createSpot(box, 0, floorPositionY, -2300, false, 'C0', 01, floor);
		 		var spot4 = this.createSpot(box, 0, floorPositionY, 2300, true, 'D0', 01, floor);
		 		var spot5 = this.createSpot(box, 0, floorPositionY, 1300, false, 'E0', 01, floor);
		 		var spot6 = this.createSpot(box, 0, floorPositionY, 600, true, 'F0', 01, floor);
		 		spot1.setParent(floor);
		 		spot2.setParent(floor);
		 		spot3.setParent(floor);
		 		spot4.setParent(floor);
		 		spot5.setParent(floor);
		 		spot6.setParent(floor);
		 		
		 		var spots = new mono.ComboNode([spot1, spot2, spot3, spot4, spot5, spot6], ['+']);
		 		spots.setParent(floor);
		 		
		 		var poleNodes = this.createPole(box, [-320, -900, -1600, -2600, 320, 900, 1600, 2600]);
		 		poleNodes.setParent(floor);
		 		
		 		var exit1 = this.createDoor(box, null, 1800, 0, 2600, 'split', 'metal', true, 'Exit');
		 		exit1.setClient('name', 'B3_Exit_1');
		 		exit1.setParent(floor);
		 		
		 		var exit2 = this.createDoor(box, null, -1700, 0, 2200, 'split', 'metal', true, 'Exit');
		 		exit2.setRotationY(-Math.PI/2);
		 		exit2.setClient('name', 'B1_Exit_2');
		 		exit2.setParent(floor);
	  	});
  		
  	};
  	
  	var decorateFloor = function(box, floor, callback) {
  		if(typeof(callback) == 'function') {
  			callback(box, floor);
  		}
  	};
  	
  	var createLift = function(box, floor){
  		var cube1=new mono.Cube(200, 1500, 200);
  		cube1.setPosition(3610, cube1.getHeight()/2, -2400);
  		cube1.setParent(floor);
  		cube1.s({
  			'm.side': mono.DoubleSide,
  			'm.texture.image': 'images/grid.png',
  			'left.texture.visible': false,
  			'm.transparent': true,
  			'm.texture.repeat': new mono.Vec2(2,10),
  		});
  		box.add(cube1);

  		var cube2=new mono.Cube(170, 250, 170);
  		cube2.setPosition(3610, cube2.getHeight()/2+800, -2400);
  		cube2.setParent(floor);
  		cube2.s({
  			'm.side': mono.DoubleSide,
  			'm.lightmap.image': 'images/outside_lightmap.jpg',
  			'm.texture.image': 'images/metal.jpg',
  			'left.texture.visible': false,
  		});
  		box.add(cube2);
  		
  		var lift = new mono.ComboNode([cube1, cube2], ['+']);
  		return lift;
  	};

  	var createPlant = function(box, x, z){
  		var w=30;
  		var h=120;
  		var pic='images/plant.png';
  		var objects=[];

  		var cylinderVase=new mono.Cylinder(w*0.6,w*0.4,h/5,20,1,false,false);
  		cylinderVase.s({
  			'm.type': 'phong',
  			'm.color': '#845527',
  			'm.ambient': '#845527',
  			'm.texture.repeat': new mono.Vec2(10,4),
  			'm.specularmap.image': 'images/metal_normalmap.jpg',
  			'm.normalmap.image':'images/metal_normalmap.jpg',
  		});			
  		var cylinderHollow=cylinderVase.clone();
  		cylinderHollow.setScale(0.9,1,0.9);
  		var cylinderMud=cylinderHollow.clone();
  		cylinderMud.setScale(0.9,0.7,0.9);
  		cylinderMud.s({
  			'm.type': 'phong',
  			'm.color': '#163511',
  			'm.ambient': '#163511',
  			'm.texture.repeat': new mono.Vec2(10,4),
  			'm.specularmap.image': 'images/metal_normalmap.jpg',
  			'm.normalmap.image':'images/metal_normalmap.jpg',
  		});
  		var vase=new mono.ComboNode([cylinderVase,cylinderHollow,cylinderMud],['-','+']);
  		objects.push(vase);

  		var count=5;
  		for(var i=0;i<count;i++){
  			var plant=new mono.Cube(w*2,h,0.01);	

  			plant.s({
  				'm.visible': false,
  				'm.alphaTest': 0.5,
  				'front.m.visible': true,
  				'front.m.texture.image': pic,
  				'back.m.visible': true,
  				'back.m.texture.image': pic,
  			});
  			plant.setParent(vase);
  			plant.setPositionY(cylinderVase.getHeight()/2+plant.getHeight()/2-3);
  			plant.setRotationY(Math.PI * i/count);
  			objects.push(plant);
  		}

  		var plantNode=new mono.ComboNode(objects);				
  		plantNode.setPosition(x, cylinderVase.getHeight()/2, z);
  		box.add(plantNode);
  		
  		var plant = new mono.Cube();
  		plantNode.setParent(plant);
  		return plant;
  	};

  	var createStair = function(box, floor){
  		var parts=[];
  		var ops=[];
  		var count=20;
  		for(var i=0;i<count;i++){
  			var cube=new mono.Cube(300,10,500-20*i);
  			cube.setPosition(0, i*10, 20*(count-i)/2);
  			cube.setParent(floor);
  			cube.s({
  				'm.type': 'phong',
  				'm.color': '#AABAC9',//'#BEC9BE',
  				'm.ambient': '#AABAC9',//'#BEC9BE',
  				'm.texture.image': 'images/floor.jpg',
  				'm.texture.repeat': new mono.Vec2(cube.getWidth()/250*2,cube.getHeight()/500*2),
  				'top.m.texture.repeat': new mono.Vec2(cube.getWidth()/250*2,cube.getDepth()/500*2),
  			});
  			parts.push(cube);
  			ops.push('+');
  		}
  		var stair=new mono.ComboNode(parts, ops);
  		stair.setPosition(2440, 10, -2490);
  		stair.setRotationY(-Math.PI/2);
  		stair.setParent(floor);
  		box.add(stair);
  		return stair;
  	};

  	var createLine = function(box, floor){
  		var path=new mono.Path();
  		path.moveTo(-580,0,-2180);
  		path.lineTo(-500,0,-1800);
  		path.lineTo(1600,0,-1800);
  		path.lineTo(1600,0,-2500);
  		path.lineTo(1950,0,-2500);
  		path.lineTo(2350,210,-2500);
  		path.lineTo(3630,210,-2400);
  		path.lineTo(3630,600,-2400);
  		path.lineTo(3130,600,-2400);
  		path.lineTo(3130,600,-1200);

  		path = mono.PathNode.prototype.adjustPath(path, 100);

  		var cable=new mono.PathNode(path, 100, 10);
  		cable.s({
  			'm.type': 'phong',
  			'm.specularStrength': 30,
  			'm.color': '#B43104',
  			'm.ambient': '#B43104',
  			'm.texture.repeat': new mono.Vec2(150, 1),
  			'm.texture.image': 'images/wall.jpg',
  			'm.visible': false
  		});
  		cable.setStartCap('plain');
  		cable.setEndCap('plain');
  		cable.setPositionY(20);
  		cable.setClient('bid', 'cable01');
  		cable.setParent(floor);
  		box.add(cable);

  		var pin=new mono.Billboard();
  		pin.s({
  			'm.texture.image': 'images/pin.png',		
  			'm.alignment': mono.BillboardAlignment.bottomCenter,
  			'm.transparent': true,
  		});
  		pin.setScale(200,0.1,1);
  		pin.setPosition(3130,600,-1200);
  		pin.setClient('bid','pin02');
  		pin.setParent(floor);
  		box.add(pin);
  	};
  	
  	var createTrail = function(box, floor){
  		var points=[[1000, 2700], [1000, 2500],[-2000, 2500],[-2000,-1800],[-600,-1800],[-600,-2200]];

  		var path=new mono.Path();
  		path.moveTo(points[0][0], points[0][1]);
  		for(var i=1;i<points.length; i++){
  			path.lineTo(points[i][0], points[i][1]);
  		}
  		path = mono.PathNode.prototype.adjustPath(path, 150);

  		var trail=new mono.PathCube(path, 40, 10);
  		trail.s({
  			'm.type': 'phong',
  			'm.specularStrength': 30,
  			'm.color': '#DF7401',
  			'm.ambient': '#DF7401', 
  			'm.visible': false		
  		});
  		trail.setRotationX(Math.PI);
  		trail.setPositionY(5);
  		trail.setClient('bid','trail01');
  		trail.setParent(floor);
  		box.add(trail);

  		var pin=new mono.Billboard();
  		pin.s({
  			'm.texture.image': 'images/pin.png',		
  			'm.alignment': mono.BillboardAlignment.bottomCenter,
  			'm.transparent': true,
  		});
  		pin.setScale(200,0.1,1);
  		pin.setPosition(-600, 0, -2200);
  		pin.setClient('bid','pin01');
  		pin.setParent(floor);
  		box.add(pin);
  		
  		return trail;
  	};

  	var createWorker = function(box, x, z, rotation, floor){
  		var obj='images/worker.obj';
  		var mtl='images/worker.mtl';               
  			
  		var loader = new mono.OBJMTLLoader();
  		loader.load(obj, mtl, {'worker': 'images/worker.png',}, function (object1) {                    			
  			object1.setScale(3,3,3);		
  			object1.setPosition(x,0,z);
  			object1.setRotationY(rotation);
  			object1.setClient('type', 'person');
  			object1.setParent(floor);	
  			box.addByDescendant(object1);
  			
  			var updater=function(element){
  				if(element && element.getChildren()){
  					element.getChildren().forEach(function(child){
  						child.setStyle('m.normalType', mono.NormalTypeSmooth);
  						updater(child);
  					});
  				}
  			}
  			updater(object1);
  		});
  	};

  	var createCar = function(box, x, y, z, rotation, floor, name){
  		var obj='car/car.obj';
  		var mtl='car/car.mtl';               
  			
  		var loader = new mono.OBJMTLLoader();
  		var pics={
  			'carbodyD': 'car/carbodyD.png',
  			'carbodyS': 'car/carbodyS.png',
  			'glass': 'car/glass.png',
  			'WheelD': 'car/WheelD.png',
  			'WheelN': 'car/WheelN.png',
  		};
  		loader.load(obj, mtl, pics, function (object1) {                    			
  			object1.setPosition(x, y, z);
  			object1.setRotationY(rotation);
  		  object1.setParent(floor);
  		  object1.setSelectable(true);
  		  object1.setClient('name', name);
  			box.addByDescendant(object1);		

  			var updater=function(element){
  				if(element && element.getChildren()){
  					element.getChildren().forEach(function(child){
  						child.s({
  							'm.normalType': mono.NormalTypeSmooth,
  						});
  						updater(child);
  					});
  				}
  			}
  			updater(object1);
  		});
  	};

  	var createShop = function(box, floor){
  		var path=new mono.Path();
  	 
  		path.moveTo(0,0);
  		path.lineTo(1960,0);
  		path.lineTo(1960,260);
  		path.lineTo(1460, 260);
  		path.lineTo(1460, 760);
  		path.lineTo(0, 760);
  		path.lineTo(0,0);

  		var node1=new mono.ShapeNode(path, 1, 220, true, 200);
  		node1.s({
  			'm.type': 'phong',
  			'm.color': '#D7DF01',
  			'm.ambient': '#D7DF01',
  			'm.transparent': true,
  			'm.opacity': 0.5,
  			'm.specularStrength': 2,
  			'm.normalmap.image': 'images/normalmap.jpg',
  		});
  		node1.setPositionX(-1480);
  		node1.setPositionZ(1280);
  		node1.setParent(floor);
  		box.add(node1);

  		var pin=new mono.Billboard();
  		pin.s({
  			'm.texture.image': 'images/logo1.png',		
  			'm.alignment': mono.BillboardAlignment.bottomCenter,
  			'm.transparent': true,
  		});
  		pin.setScale(200,200,1);
  		pin.setParent(node1); 
  		pin.setPositionX(800);
  		pin.setPositionY(node1.getAmount());
  		pin.setPositionZ(-500);
  		box.add(pin);

  		//another shop.
  		var path=new mono.Path();
  	 
  		path.moveTo(0,0);
  		path.lineTo(540,0);
  		path.lineTo(540,960);
  		path.lineTo(0, 960);
  		path.lineTo(0, 0);

  		var node2=new mono.ShapeNode(path, 1, 220, true, 200);
  		node2.s({
  			'm.type': 'phong',
  			'm.color': '#04B45F',
  			'm.ambient': '#04B45F',
  			'm.transparent': true,
  			'm.opacity': 0.5,
  			'm.specularStrength': 2,
  			'm.normalmap.image': 'images/normalmap.jpg',
  		});
  		node2.setPosition(930, 0, 2280);
  		node2.setParent(floor);
  		box.add(node2);

  		var pin=new mono.Billboard();
  		pin.s({
  			'm.texture.image': 'images/logo2.png',		
  			'm.alignment': mono.BillboardAlignment.bottomCenter,
  			'm.transparent': true,
  		});
  		pin.setScale(200,200,1);
  		pin.setParent(node2); 
  		pin.setPosition(300, node2.getAmount(), -500);
  		box.add(pin);
  		
  		var shop = new mono.ComboNode([node1, node2], ['+']);
  		return shop;
  	};

  	var createWalls = function(box){
  		this.createWallFloor(box, 3000, 2000, 0, 0, 1300);
  		this.createWall(box, [[-1000, 4950], [4000, 4950], [4000, 2950]]);
  		this.createWall(box, [[0, 0],[3000, 0],[3000, 2000],[0, 2000],[0,0]], false, {x: 650, z: 2300});
  		this.createWall(box, [[0, 1000],[3000, 1000]], true);
  		this.createWall(box, [[400, 0],[400, 1000]], true);
  		this.createWall(box, [[700, 0],[700, 1000]], true);
  		this.createWall(box, [[1200, 0],[1200, 1000]], true);
  		this.createWall(box, [[1500, 0],[1500, 1000]], true);
  		this.createWall(box, [[1900, 0],[1900, 1000]], true);
  		this.createWall(box, [[2400, 0],[2400, 1000]], true);
  		this.createWall(box, [[0, 500],[100, 500]], true);
  		this.createWall(box, [[0, 1800],[1500, 1800],[1500, 1300],[2000,1300],[2000,1000]], true);

  		this.createWall(box, [[3990, 4950], [5000, 4950],[5000,4800]]).s({'m.transparent':true,'m.opacity':0.5}).setPositionY(180);
  		this.createWall(box, [[5000,4600],[5000,2950],[4500,2950]]).s({'m.transparent':true,'m.opacity':0.5}).setPositionY(180);
  		
  		this.createWall(box, [[4500, 4950], [5000, 4950],[5000,4800]]).s({'m.transparent':true,'m.opacity':0.5}).setPositionY(580);
  		this.createWall(box, [[5000,4600],[5000,2950],[4500,2950]]).s({'m.transparent':true,'m.opacity':0.5}).setPositionY(580);
  	};

  	var createWall = function(box, data, inside, door){
  		var path=new mono.Path();
  		path.moveTo(data[0][0], data[0][1], 0);
  		for(var i=1;i<data.length;i++){
  			path.lineTo(data[i][0], data[i][1], 0);
  		}

  		var thick=20, height=200;
  		var outsideColor= inside ? '#B8CAD5' : '#CEE3F6', insideColor='#B8CAD5', topColor='#D6E4EC';
  		var wall= new mono.PathCube(path, thick, height, 1, 100);
  		wall.s({
  			'outside.m.color': outsideColor,
  			'inside.m.type': 'basic',
  			'inside.m.color': insideColor,
  			'aside.m.color': outsideColor,
  			'zside.m.color': outsideColor,
  			'top.m.color': topColor,
  			'bottom.m.color': topColor,
  			'inside.m.lightmap.image': 'images/inside_lightmap.jpg',
  			'outside.m.lightmap.image': 'images/outside_lightmap.jpg',
  			'aside.m.lightmap.image': 'images/outside_lightmap.jpg',
  			'zside.m.lightmap.image': 'images/outside_lightmap.jpg',
  		});
  		if(!inside){
  			wall.s({
  				'outside.m.texture.image': 'images/wall.jpg',
  			});
  		}
  		wall.setPosition(-1500, 0, 2300);

  		if(door){
  			this.createDoor(box, wall, door.x, 0, door.z);
  		}else{
  			box.add(wall);
  		}
  		return wall;
  	};

  	var createFloor = function (box, width, y, height){	
  		var floor=new mono.Cube(width, 30, height);
  		floor.setPositionY(-floor.getHeight()/2+y);
  		floor.s({
  			'm.type': 'phong',
  			'm.color': '#CEE3F6',//'#BEC9BE',
  			'm.ambient': '#CEE3F6',//'#BEC9BE',
  			'top.m.type':'basic',
  			'top.m.texture.image': 'images/floor.jpg',
  			'top.m.texture.repeat': new mono.Vec2(width/250*2,height/500*2),
  			'top.m.polygonOffset':true,
  			'top.m.polygonOffsetFactor':3,
  			'top.m.polygonOffsetUnits':3,
  		});
  		box.add(floor);
  		return floor;
  	};

  	var createWallFloor = function(box, width, height, x, y, z){
  		var floor=new mono.Cube(width, 1, height);
  		floor.s({
  			'm.type': 'phong',
  			'm.color': '#BEC9BE',
  			'm.ambient': '#BEC9BE',
  			'top.m.type':'basic',
  			'top.m.texture.image': 'images/floor.jpg',
  			'top.m.texture.repeat': new mono.Vec2(width/250*2,height/500*2),
  			'top.m.polygonOffset':true,
  			'top.m.polygonOffsetFactor':3,
  			'top.m.polygonOffsetUnits':3,
  		});
  		floor.setPosition(x, y, z);
  		box.add(floor);
  	};

  	var createSpot = function(box, x, y, z, reversed, prefix, id, floor){
  		var floorName=floor.getClient('name');
  		var carspot = new mono.Cube();
  		
  		var area=this.createSpotArea(box, carspot, 2600, 600, x,y,z, reversed, floor);
  		
  		var width=250;
  		var height=500;
  		for(var i=0;i<10;i++){
  			var spotName=prefix+(id+i);
  			var spotX=i*250-1100;
  			this.createSingleSpot(box, carspot, area, floorName, spotName, spotX, width, height);
  		}

			return carspot;
  	};
		
		var createSingleSpot=function(box, carspot, area, floorName, spotName, x, width, height){
			var spot=new mono.Cube(width, 1, height);
  			spot.s({
  				'm.visible': false,
  			});
  			spot.s({
  				'm.type':'basic',
  				'm.transparent': true,
  				'top.m.visible': true,
  				'top.m.texture.image': 'images/spot.png',		
  			});
  			spot.setSelectable(true);
  			spot.setParent(area);
  			
  			//var spotName=prefix+(id+i);
  			spot.setClient('bid', spotName);
  			spot.setClient('name', floorName+"_"+spotName);
  			spot.setClient('type', 'spot');
  			
  			spot.setPositionX(x); //i*250-1100;
  			spot.setPositionY(spot.getPositionY()+1);
  			spot.setRotationY(spot.getParent().getRotationY());
  			box.add(spot);

  			var block=new mono.Cylinder(5, 5, width * 0.6);
  			block.s({
  				'm.type':'phong',
  				'm.color': '#D39C1A',
  				'm.ambient': '#D39C1A',
  				'side.m.texture.image': 'images/block.png',		
  				'side.m.texture.repeat': new mono.Vec2(1, 3),
  				'top.m.color': 'black',
  				'bottom.m.color': 'black',
  				'm.specularStrength': 20,
  			});
  			block.setParent(spot);
  			block.setPositionY(block.getPositionY()+5);
  			block.setRotationZ(Math.PI/2);
  			block.setPositionZ(-215);
  			box.add(block);

  			var label=new mono.Cube(150,2,75);		
  			var canvas=this.generateAssetImage(spotName, '#E6E6E6');
  			label.setStyle('m.visible', false);
  			label.s({
  				'top.m.visible': true,
  				'top.m.texture.image': canvas,
  				'm.transparent': true,
  				'm.texture.anisotropy': 32,
  			});
  			label.setPositionZ(200);
  			label.setParent(spot);
  			box.add(label);
  			
  			var ps = new mono.ComboNode([spot, block, label], ['+']);
  			ps.setParent(carspot);
		};

	  var createSpotArea = function(box, carspot, width, height, x, y, z, reversed, floor){
	  	carspot.setParent(floor);
  		carspot.setClient('name','CarSpot');
  		
  		var cube=new mono.Cube(width, 1, height);
  		cube.s({
  			'm.type': 'phong',
  			'm.color': '#0B6138',
  			'm.ambient': '#0B6138',
  			'm.specularStrength': 20,
  		});
  		var border=20;
  		var cubeBorder=new mono.Cube(cube.getWidth()+border*2, 1, cube.getDepth()+border*2);
  		cubeBorder.s({
  			'm.color': '#E4F6F6',
  		});	
  		var area=new mono.ComboNode([cubeBorder, cube, cube], ['-', '+']);
  		area.setParent(carspot);
  		area.setPosition(x, y+15, z);
  		area.setClient('name','Area');
  		
  		if(reversed){
  			area.setRotationY(Math.PI);
  		}
  		box.add(area);
  		return area;
  	};

  	var createPoleObject = function(box, x, z){
  		var cube=new mono.Cube(45, 100, 45);
  		cube.s({
  			'm.type': 'phong',
  			'm.texture.image': 'images/pole.png',
  		});
  		cube.s({
  			'top.m.texture.image': '',
  			'top.m.texture.image': 'images/floor.jpg',
  			'top.m.color': '#E6EEF6',//'#BEC9BE',
  			'top.m.ambient': '#E6EEF6',//'#BEC9BE',
  		});
  		cube.setPositionY(cube.getHeight()/2);

  		var cube2=new mono.Cube(40, 380, 40);
  		cube2.s({
  			'm.type': 'phong',
  			'm.texture.image': 'images/floor.jpg',
  			'm.color': '#E6EEF6',//'#BEC9BE',
  			'm.ambient': '#E6EEF6',//'#BEC9BE',
  			'm.texture.repeat': new mono.Vec2(1, 5),
  		});
  		cube2.setPositionY(cube2.getHeight()/2);
  		
  		var pole=new mono.ComboNode([cube, cube2], ['+']);
  		pole.setPositionX(x);
  		pole.setPositionZ(z);
  		
  		return pole;
  	};

  	var createPole = function(box, positionZs){
  		var poles = [];
  		for(var i=0;i<3;i++){
  			for(var j in positionZs) {
  				poles.push(this.createPoleObject(box, -1280+i*1300, positionZs[j]));
  			}
  		}
  		var poleNodes = new mono.ComboNode(poles, ['+']);
  		box.add(poleNodes);
  		return poleNodes;
  	};

  	var createCam = function(box, x, z, name) {
  		var cam=new mono.Sphere(60, 40, 40, 0, Math.PI*2, Math.PI/2, Math.PI/2);
  		cam.setPosition(x, -10, z);
  		cam.setRotationY(Math.PI);
  		cam.setStyle('m.texture.image', 'images/cam.jpg')
  		cam.setClient('name', name);
  		box.add(cam);
  		return cam;
  	};
  	
  	var createTemperatureProbe = function(box, x, z, name) {
  		var tp=new mono.Sphere(50, 40, 40, 0, Math.PI*2, Math.PI/2, Math.PI/2);
  		tp.setPosition(x, -10, z);
  		tp.setRotationY(Math.PI);
  		tp.setStyle('m.texture.image', 'images/temperature.jpg')
  		tp.setClient('type', 'temperature');
  		tp.setClient('name', name);
  		box.add(tp);
  		return tp;
  	};
  	
  	var generateAssetImage = function(text, textColor, fillColor){         
  		var width=512, height=256;

  		var canvas = document.createElement('canvas');
  		canvas.width  = width;
  		canvas.height = height;

  		var ctx = canvas.getContext('2d');		
  		if(fillColor){
  			ctx.fillStyle=fillColor
  			ctx.fillRect(0,0,width,height);
  		}
  		
  		ctx.font = 150+'px "Microsoft Yahei" normal';
  		ctx.fillStyle = textColor || 'black';
  		ctx.textAlign = 'center';
  		ctx.textBaseline = 'middle';
  		//ctx.fillText(text, width/2,height/2);
  		ctx.strokeStyle=textColor || 'black';
  		ctx.lineWidth=15;
  		ctx.strokeText(text, width/2,height/2);

  		return canvas;   
  	};

  	var handleDoubleClick = function(e, network){
  		var camera=network.getCamera();
  		var interaction=network.getDefaultInteraction();
  		var firstClickObject=this.findFirstObjectByMouse(network,e);
  		if(firstClickObject){
  			var element=firstClickObject.element;					
  			var newTarget=firstClickObject.point;
  			var oldTarget=camera.getTarget();
  			
  			if(element.getStyle('lazy.function')){
  				var loader=element.getStyle('lazy.function');
  				var time1=new Date().getTime();
  				loader();
  				var time2=new Date().getTime();
  			}
  			
  			
  			var elementName=element.getClient('name');
  			console.log(elementName+',pos=('+element.getPositionX()+","+element.getPositionY()+","+element.getPositionZ()+')');
  			var newPos=this.getAbsolutedPosition(element);
  			console.log(elementName+',new pos=('+newPos[0]+','+newPos[1]+','+newPos[2]+')');
  			
  			if(elementName){
  				var fs=elementName.split('_');
  				if(fs && fs.length==2){
  					this.$('#create_park_floor').val(fs[0]);
  					this.$('#create_park_spot').val(fs[1]);
  				}
  		  }
  		  
  			if(element.getClient('bid') && element.getClient('bid') == 'C046'){
  				var pin01 = this.bidFinder.findFirst('pin01');
  				var trail01 = this.bidFinder.findFirst('trail01');
  				new twaver.Animate({
  					from: 0,
  					to: 1,
  					dur: 2000,
  					easing: 'bounceOut',
  					onUpdate: function(value){
  						pin01.setScaleY(value*200);
  					},
  					onDone: function(){
  						trail01.setStyle('m.visible', true);
  					}

  				}).play();
  			}else if(element.getClient('name') && element.getClient('name') == 'F2'){
  				var pin02 = this.bidFinder.findFirst('pin02');
  				var cable01 = this.bidFinder.findFirst('cable01');
  				new twaver.Animate({
  					from: 0,
  					to: 1,
  					dur: 2000,
  					easing: 'bounceOut',
  					onUpdate: function(value){
  						pin02.setScaleY(value*200);
  					},
  					onDone: function(){
  						cable01.setStyle('m.visible', true);
  					}

  				}).play();
  			}else if(element.getClient('name') && element.getClient('name') == 'B2') {
  				var F1 = this.nameFinder.findFirst('F1');
  				changePositionY(F1, isDetail ? -2000 : 2000, false);
  				
  				var F2 = this.nameFinder.findFirst('F2');
  				changePositionY(F2, isDetail ? -2000 : 2000, false);
  				
  				var B1 = this.nameFinder.findFirst('B1');
  				changePositionY(B1, isDetail ? -2000 : 2000, false);
  				
  				//var B2 = this.nameFinder.findFirst('B2');
  				//B2.setRotationZ(B2.getRotationZ()+(isDetail ? -Math.PI/2 : Math.PI/2));
  				
  				var B3 = this.nameFinder.findFirst('B3');
  				changePositionY(B3, isDetail ? 2000 : -2000, false);
  				
  				isDetail = !isDetail;
  			}else if(element.getClient('type') && element.getClient('type') == 'temperature') {
  				var name = element.getClient('name');
  				var floor = element.getParent().getClient('name');
  				
  	  			var dialog = '<div><div>楼层：'+floor+'</div><div>位置：'+name.split('_')[2]+'</div><div>状态：正常</div></div>';
  	  			$('body').innerHTML = dialog;
  	  			
  	  			$(dialog).dialog({
  	  				title: '温度探测器 ',
	                autoOpen: true,
	                height: 200,
	                width: 300,
	                modal: true,
	                close: function() {
	                  $(this).dialog( "close" );
	                }
  	  			});
  			}else{
  				this.animateCamera(camera, interaction, oldTarget, newTarget, function(){
  					if(element.getClient('animation')){
  						playAnimation(element, element.getClient('animation'));
  					}				
  				});
  			}
  		}else{
  			var oldTarget=camera.getTarget();
  			var newTarget=new mono.Vec3(0,0,0);
  			this.animateCamera(camera, interaction, oldTarget, newTarget);
  		}
  	};

  	var handleClick = function(e, network) {
  		var camera=network.getCamera();
  		var interaction=network.getDefaultInteraction();
  		var firstClickObject=this.findFirstObjectByMouse(network,e);
  		if(firstClickObject){
  			var element=firstClickObject.element;					
  			var newTarget=firstClickObject.point;
  			var oldTarget=camera.getTarget();
  			
  			var type = element.getClient('type'),
  			    name = element.getClient('name');
  			
  			if(type == 'spot') {
		    	this.$('#create_park_floor').val(name.split('_')[0]);
		    	this.$('#create_park_spot').val(name.split('_')[1]);
  			}
  		}
  	};
  	
  	var changePositionY = function(element, value, isCombine) {
  		if(!isCombine) {
  			element.setPositionY(element.getPositionY()+value);
  		}
  		
  		var children = isCombine ? element.combos : element.getChildren();
  		children.forEach(function(child) {
  			if(child.getParent()){
  				// do nothing because the parent has moved.
  			}else{
  			     changePositionY(child, value, child.combos && child.combos.length > 0);
  		  }
		});
  	};
  	
  	var setupLights = function(box){
  		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
  		pointLight.setPosition(0,1000,-1000);
  		box.add(pointLight);     
  		
  		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
  		pointLight.setPosition(0,1000,1000);
  		box.add(pointLight);        

  		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
  		pointLight.setPosition(1000,-1000,-1000);
  		box.add(pointLight);        

  		box.add(new mono.AmbientLight('white'));	
  	};

  	var findFirstObjectByMouse = function(network, e){
  		var objects = network.getElementsByMouseEvent(e);
  		if (objects.length) {
  			for(var i=0;i<objects.length;i++){			
  				var first = objects[i];
  				var object3d = first.element;
  				if(! (object3d instanceof mono.Billboard)){
  					return first;
  				}
  			}
  		}
  		return null;
  	};

  	var animateCamera = function(camera, interaction, oldPoint, newPoint, onDone){
  		twaver.Util.stopAllAnimates(true);
  		
  		var offset=camera.getPosition().sub(camera.getTarget());
  		var animation=new twaver.Animate({
  			from: 0,
  			to: 1,
  			dur: 500,
  			easing: 'easeBoth',
  			onUpdate: function (value) {
  				var x=oldPoint.x+(newPoint.x-oldPoint.x)*value;
  				var y=oldPoint.y+(newPoint.y-oldPoint.y)*value;
  				var z=oldPoint.z+(newPoint.z-oldPoint.z)*value;
  				var target=new mono.Vec3(x,y,z);				
  				camera.lookAt(target);
  				interaction.target=target;
  				var position=new mono.Vec3().addVectors(offset, target);
  				camera.setPosition(position);
  			},
  		});
  		animation.onDone=onDone;
  		animation.play();
  	};

  	var playAnimation = function(element, animation){
  		var params=animation.split('.');
  		if(params[0]==='move'){
  			var direction=params[1];
  			animateMove(element, direction);
  		}
  		if(params[0]==='rotate'){
  			var anchor=params[1];
  			var angle=params[2];
  			animateRotate(element, anchor, angle);
  		}
  	};

  	var animateMove = function(object, direction){
  		twaver.Util.stopAllAnimates(true);

  		var size=object.getBoundingBox().size().multiply(object.getScale());

  		var movement=0.8;
  		
  		var directionVec=new mono.Vec3(0, 0, 1);
  		var distance=0;
  		if(direction==='x'){
  			directionVec=new mono.Vec3(1, 0, 0);
  			distance=size.x;
  		}
  		if(direction==='-x'){
  			directionVec=new mono.Vec3(-1, 0, 0);
  			distance=size.x;
  		}
  		if(direction==='y'){
  			directionVec=new mono.Vec3(0, 1, 0);
  			distance=size.y;
  		}
  		if(direction==='-y'){
  			directionVec=new mono.Vec3(0, -1, 0);
  			distance=size.y;
  		}
  		if(direction==='z'){
  			directionVec=new mono.Vec3(0, 0, 1);
  			distance=size.z;
  		}
  		if(direction==='-z'){
  			directionVec=new mono.Vec3(0, 0, -1);
  			distance=size.z;
  		}

  		distance=distance*movement;
  		if(object.getClient('animated')){
  			directionVec=directionVec.negate();
  		}

  		var fromPosition=object.getPosition().clone();		
  		object.setClient('animated', !object.getClient('animated'));

  		new twaver.Animate({
  			from: 0,
  			to: 1,
  			dur: 2000,
  			easing: 'bounceOut',
  			onUpdate: function (value) {
  				//don't forget to clone new instance before use them!
  				object.setPosition(fromPosition.clone().add(directionVec.clone().multiplyScalar(distance * value)));
  			},
  		}).play();
  	};

  	var animateRotate = function(object, anchor, angle){
  		twaver.Util.stopAllAnimates(true);

  		var size=object.getBoundingBox().size().multiply(object.getScale());
  		
  		var from=0;
  		var to=1;
  		if(object.getClient('animated')){
  			to=-1;
  		}
  		object.setClient('animated', !object.getClient('animated'));
  		
  		var position;
  		var axis;
  		if(anchor==='left'){
  			position=new mono.Vec3(-size.x/2, 0, 0);
  			var axis=new mono.Vec3(0,1,0);
  		}
  		if(anchor==='right'){
  			position=new mono.Vec3(size.x/2, 0, 0);
  			var axis=new mono.Vec3(0,1,0);
  		}

  		var animation=new twaver.Animate({
  			from: from,
  			to: to,
  			dur: 1800,
  			easing: 'bounceOut',
  			onUpdate: function (value) {					
  				if(this.lastValue===undefined){
  					this.lastValue=0;
  				}
  				object.rotateFromAxis(axis.clone(), position.clone(), Math.PI/180*angle*(value-this.lastValue));
  				this.lastValue=value;
  			},
  			onDone: function(){
  				delete this.lastValue;
  			},
  		});
  		animation.play();
  	};

  	var getRandomInt = function(max){
  		return parseInt(Math.random()*max);
  	};

  	var createDoor = function(box, wall, x, y, z, animation, type, doorframe, label){	
  		var width=205, height=180, depth=26;	
  		var frameEdge=10, frameBottomEdge=2;
  		
  		var frame=new mono.Cube(width, height, depth);
  		frame.s({
  			'm.color': '#B8CAD5',
  			'm.ambient': '#B8CAD5',
  			'm.lightmap.image': 'images/inside_lightmap.jpg',
  			'm.type': 'phong',
  			'm.specularStrength': 0.1,
  		});
  		frame.setPosition(x, frame.getHeight()/2+y, z);

  		var cut=new mono.Cube(width-frameEdge, height-frameEdge/2-frameBottomEdge, depth+2);
  		cut.s({
  			'm.color': '#B8CAD5',
  			'm.ambient': '#B8CAD5',
  			'm.lightmap.image': 'images/inside_lightmap.jpg',
  			'm.type': 'phong',
  			'm.specularStrength': 0.1,
  			'bottom.m.lightmap.image': 'images/floor.jpg',
  		});
  		cut.setPosition(x, cut.getHeight()/2+frameBottomEdge+y, z);
  		
  		var frame=new mono.ComboNode([frame, cut], ['-']);
  		box.add(frame);

  		if(wall){
  			var cutwall=new mono.ComboNode([wall, cut],['-']);
  			box.add(cutwall);
  		}
  		
  		if(!doorframe) {
  			var left=new mono.Cube((width-frameEdge)/2-2, height-frameEdge/2-frameBottomEdge-2, 2);
  	  		left.setPosition(x-(width-frameEdge)/4, frameBottomEdge+1+left.getHeight()/2+y, z);
  	  		left.s({
  	  			'm.color': 'orange',
  	  			'm.ambient': 'orange',
  	  			'm.type': 'phong',
  	  			'm.transparent': true,
  	  			'front.m.texture.image': 'images/door_left.png',					
  	  			'back.m.texture.image': 'images/door_right.png',					
  	  			'm.specularStrength': 100,
  	  			'm.envmap.image': this.envmap,
  	  			'm.specularmap.image': 'images/white.png',	
  	  		});		
  	  		if(type==='metal'){
  	  			left.s({
  	  				'm.color': '#A4A4A4',
  	  				'm.ambient': '#A4A4A4',
  	  				'm.transparent': false,
  	  				'm.texture.image': 'images/metal.jpg',					
  	  				'm.specularStrength': 30,
  	  				'm.envmap.image': null,
  	  			});	
  	  		}
  	  		left.setClient('animation', 'rotate.left.-90');
  	  		if(animation==='split'){
  	  			left.setClient('animation', 'move.-x');
  	  		}
  	  		left.setParent(frame);
  	  		box.add(left);
  	  		
	  	  	var right=left.clone();
	  		right.setPositionX(x+(width-frameEdge)/4);
	  		right.setRotationY(Math.PI);
	  		right.setParent(frame);
	  		right.setClient('animation', 'rotate.left.90');
	  		if(animation==='split'){
	  			right.setClient('animation', 'move.x');
	  		}
	  		box.add(right);	
  		}
  		
  		if(label){
			var textNode = new mono.TextNode(label,40,2,'helvetiker','bold');
			textNode.setSelectable(false);
			textNode.setParent(frame);
			textNode.setPosition(x, textNode.getPositionY()+200, z);
			box.add(textNode);
		}  

  		return frame;
  	};
  	
  	var setEvents = function(box) {
  		var self=this;
  		$('.menu input').on('click', function() {
  			var name = this.name;
  			switch(name) {
  			case 'searchshop':
  				self.searchShop();
  				break;
  			case 'clear':
  				break;
  			case 'create':
  			  self.createNewSpot();
  				break;
  			case 'createCar':
  				self.startParking();
  				break;
  			case 'leaveParking':
  				self.leaveParking();
  				break;
  			}
  		});
  		
  	};
  	
    </script>
</head>

<body onload='setup()'>
    <div class="menu">
        <input type="button" value="搜索商家" name="searchshop" />
        <input type="text" value="关键字" id="shopname" style="width:80px; margin-right: 20px;" />
        
        <input type="button" value="清空车位" name="clear" />
        
        <input type="button" value="建立车位" name="create" />
        <input type="text" value="landscape" id="spotdirection" style="width:60px;" />
        <input type="text" value="6" id="spotnumber" style="width:60px;" />
        <input type="text" value="H0" id="spotprefix" style="width:60px; margin-right: 20px;" />

        <input type="text" value="B1" id="create_park_floor" style="width:40px;" />
        <input type="text" value="A010" id="create_park_spot" style="width:60px;" />
        <input type="button" value="停车" name="createCar" />
        <input type="button" value="离开车库" name="leaveParking" />
    </div>
    <div>
        <canvas id="myCanvas"/>
    </div>
</body>

</html>
